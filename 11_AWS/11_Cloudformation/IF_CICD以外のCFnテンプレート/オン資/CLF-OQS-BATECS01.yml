############################
# Copyright© 2019 FUJITSU LIMITED
# FileName: CLF-OQS-MT2-BATECS01.yml
# FileType: YAML
# OverViews: CloudFormation Template for MT2 Batch ECS
# Version: 1.0
# Author: Fujitsu - minegishi
############################
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  #  ## user form  ##
  #  :param Environment: システム環境の指定（DEV/STG/MNT/PRO/MT2）
  #  :param VpcId: ECSで対象となるVPCIDを指定
  #  :param ClusterType: ECSクラスタ名などに使用されるコンテナ識別を指定
  #  :param Number: 同一コンテナタイプで何番目のクラスタか指定
  #  :param KeyName: ECSでデプロイされるEC2インスタンスでsshログインに使用されるキーペア名を指定
  #  :param SubnetId: ECSで対象となるSubnetIDを指定
  #  :param DesiredCapacity: ECSで利用するEC2インスタンスの数を指定
  #  :param MaxSize: AutoScaling設定時のEC2インスタンス最大数を指定
  #  :param InstanceType: EC2インスタンスのサイズを指定
  #  :param AWSRegionToAMI: EC2で利用するAMI IDを指定※ただし、事前にECS暗号化済みのカスタムイメージを指定すること
  #
  Environment:
    Type: String
    Description: Specify the environment to deploy
    Default: 'ST2'
    AllowedValues: ['DEV','STG','MNT','PRO','MT1','MT2','ST2']
  VpcId:
    Type: String
    Description: Select a VPC that allows instances access to the Internet
    Default: 'vpc-05a92eb3a01283e6d'
  ClusterType:
    Type: String
    Description: ECS Cluster Type
    Default: 'BAT'
    AllowedValues: ['WEB','BAT']
  Number:
    Type: String
    Description: ECS Cluster Number
    Default: '01'
    AllowedValues: ['01','02','03','04','05']
  KeyName:
    Type: String
    Description: Name of an existing EC2 KeyPair to enable SSH access to the ECS instances
    Default: 'key-or-stg'
  SubnetId:
    Type: CommaDelimitedList
    Description: Select at two subnets in your selected VPC
    Default: subnet-0469e574efe23e62d,subnet-08c1c7c4349d0bc26,subnet-087ea3efab6722d59
  SecurityGroup:
    Type: CommaDelimitedList
    Description: SecurityGroup id for the ECS instances
    Default: "sg-054e6c1e7f3eac750,sg-0452aa06d4f9d33f0"
  DesiredCapacity:
    Type: Number
    Default: '1'
    Description: Number of instances to launch in your ECS cluster.
  MinSize:
    Type: Number
    Default: '1'
    Description: Minimum number of instances that can be launched in your ECS cluster.
  MaxSize:
    Type: Number
    Default: '2'
    Description: Maximum number of instances that can be launched in your ECS cluster.
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: r5.large
    ConstraintDescription: Please choose a valid instance type.
  AWSRegionToAMI:
    Description: EC2 instance AMI Image
    Type: String
    Default: ami-09de3d958c5453aa3
  EbsVolumeSize:
    Type: Number
    Description: >
      Optional - Specifies the Size in GBs, of the newly created Amazon
      Elastic Block Store (Amazon EBS) volume
    Default: '100'
  EbsVolumeType:
    Type: String
    Description: Optional - Specifies the Type of (Amazon EBS) volume
    Default: 'gp2'
    AllowedValues:
      - ''
      - standard
      - io1
      - gp2
      - sc1
      - st1
    ConstraintDescription: Must be a valid EC2 volume type.
  DeviceName:
    Type: String
    Default: '/dev/xvda'
    Description: Optional - Specifies the device mapping for the Volume
  MinInstancesInService:
    Type: Number
    Default: '2'
    Description: Minimum number of instances that should be running during updating in your ECS cluster.
Resources:
  #  ##  ECS  ##
  #  :param : ECSCluster: ECSのクラスタ定義をデプロイ
  #  :param : ECSAutoScalingGroup: EC2のAutoScalingの設定
  #  :param : ContainerInstances: EC2インスタンスをデプロイ
  #  :param : EC2Role: WEB ECSで設定を行う
  #  :param : AutoscalingRole:
  #  :param : EC2InstanceProfile:
  #
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ECS-OQS-${Environment}-${ClusterType}${Number}
      Tags:
        - Key: AutoOperate
          Value: !Sub ${ClusterType}-${Environment}
  ECSAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      # AutoScalingGroupName: !Sub AS-OQS-${Environment}-${ClusterType}ECS${Number}
      VPCZoneIdentifier: !Ref SubnetId
      LaunchConfigurationName: !Ref ContainerInstances
      HealthCheckGracePeriod: 300 #ヘルスチェックの猶予期間
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      TerminationPolicies: ['NewestInstance']
      Tags:
        - Key: Name
          Value: !Sub EC2-OQS-${Environment}-${ClusterType}ECS${Number}
          PropagateAtLaunch: 'true'
        - Key: BillingGroup
          Value: !Sub OQS-ST2
          PropagateAtLaunch: 'true'
        - Key: AutoOperate
          Value: !Sub ${ClusterType}-${Environment}
          PropagateAtLaunch: 'true'
    #CreationPolicy:
    #  ResourceSignal:
    #    Timeout: PT15M
    UpdatePolicy:
#      AutoScalingReplacingUpdate:
#        WillReplace: 'true'
      AutoScalingRollingUpdate:
        MinInstancesInService: !Ref MinInstancesInService
        PauseTime: PT5M

  ContainerInstances:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !Ref AWSRegionToAMI
      SecurityGroups: !Ref SecurityGroup
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref EC2InstanceProfile
      KeyName: !Ref KeyName
      BlockDeviceMappings:
      - DeviceName: !Ref DeviceName
        Ebs:
         VolumeSize: !Ref EbsVolumeSize
         VolumeType: !Ref EbsVolumeType
######################################################################################
####USERDATA area############
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          hostnamectl set-hostname ecs-oqs-st2-bat01

          yum install aws-cli -y
          yum install wget -y
          wget https://s3.ap-northeast-1.amazonaws.com/amazoncloudwatch-agent-ap-northeast-1/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
          rpm -U ./amazon-cloudwatch-agent.rpm
          sleep 15
          aws s3 cp s3://s3-oqs-st2-ecs-userdata-file01/bat_amazon-cloudwatch-agent.json /tmp/amazon-cloudwatch-agent.json
          cp /tmp/amazon-cloudwatch-agent.json /opt/aws/amazon-cloudwatch-agent/etc/
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2  -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
          echo ECS_CLUSTER=ECS-OQS-${Environment}-${ClusterType}${Number} >> /etc/ecs/ecs.config
          echo ECS_IMAGE_PULL_BEHAVIOR=always >> /etc/ecs/ecs.config
          yum install -y aws-cfn-bootstrap
          ACTIVATIONURL='dsm://10.108.17.11:4120/'
          MANAGERURL='https://10.108.17.11:4119'
          CURLOPTIONS='--silent --tlsv1.2'
          linuxPlatform='';
          agentVersion='20.0.0.1681';
          isRPM='';
          curl $MANAGERURL/software/deploymentscript/platform/linuxdetectscriptv1/ -o /tmp/PlatformDetection $CURLOPTIONS --insecure
          . /tmp/PlatformDetection
          platform_detect
          echo Downloading agent package...
          package='agent.rpm'
          curl $MANAGERURL/software/agent/$linuxPlatform/$agentVersion -o /tmp/$package $CURLOPTIONS --insecure
          echo Installing agent package...
          rpm -ihv /tmp/agent.rpm
          sleep 15
          /opt/ds_agent/dsa_control -r
          /opt/ds_agent/dsa_control -a $ACTIVATIONURL "policyid:12"
          echo "DSA終了"
          # /opt/ds_agent/dsa_control -a dsm://10.108.17.11:4120/ "policyid:12"
          yum -y install amazon-efs-utils
          mkdir -p /mnt/tokken
          #### Switch comments in the event of an AZ failure ####
          echo 10.110.49.43 fs-087428102695d6d12.efs.ap-northeast-1.amazonaws.com >> /etc/hosts
          # echo 10.110.49.112 fs-087428102695d6d12.efs.ap-northeast-1.amazonaws.com >> /etc/hosts
          # echo 10.110.49.144 fs-087428102695d6d12.efs.ap-northeast-1.amazonaws.com >> /etc/hosts
          mount -t efs -o tls,accesspoint=fsap-03c5aed3c81a602b5 fs-087428102695d6d12:/ /mnt/tokken
          ################################################################################################################################################
          #EFS Failover setting
          #sudo useradd -G wheel efs-user01
          #echo "efs-user01 ALL=NOPASSWD: ALL" | sudo tee -a /etc/sudoers
          #aws s3 cp s3://s3-oqs-st2-ecs-userdata-file01/EFS/EFSMountCheck.sh /home/efs-user01
          #aws s3 cp s3://s3-oqs-st2-ecs-userdata-file01/EFS/EFSMountChange.sh /home/efs-user01
          #aws s3 cp s3://s3-oqs-st2-ecs-userdata-file01/EFS/EFSLogLifecycle.sh /home/efs-user01
          #aws s3 cp s3://s3-oqs-st2-ecs-userdata-file01/EFS/EFSMount_OQS_ST2.env /home/efs-user01
          #sudo mkdir -p /var/log/efs_mount_check/tokken/
          #sudo chown efs-user01.efs-user01 /home/efs-user01/EFSMountCheck.sh
          #sudo chown efs-user01.efs-user01 /home/efs-user01/EFSMountChange.sh
          #sudo chown efs-user01.efs-user01 /home/efs-user01/EFSMount_OQS_ST2.env
          #echo '*/1 * * * * efs-user01 sudo sh /home/efs-user01/EFSMountCheck.sh "/tokken" | sudo tee -a /var/log/efs_mount_check/tokken/$(date +\%y\%m\%d).log' | sudo tee -a /etc/crontab
          #echo '* * */1 * * efs-user01 sudo sh /home/efs-user01//EFSLogLifecycle.sh "/tokken"' | sudo tee -a /etc/crontab
          ################################################################################################################################################


  #ECSインスタンスのスケーリングポリシー設定
  ECSInstanceScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref ECSAutoScalingGroup #??
      EstimatedInstanceWarmup: 300
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration: #TargetTrackingScaling?????
        DisableScaleIn: false
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 90
#  service:
#    Type: AWS::ECS::Service
#    DependsOn: ALBListener
#    Properties:
#      Cluster: !Ref 'ECSCluster'
#      DesiredCount: '1'
#      LoadBalancers:
#      - ContainerName: simple-app
#        ContainerPort: '80'
#        TargetGroupArn: !Ref 'ECSTG'
#      Role: !Ref 'ECSServiceRole'
#      TaskDefinition: !Ref 'taskdefinition'
#  ECSServiceRole:
#    Type: AWS::IAM::Role
#    Properties:
#      AssumeRolePolicyDocument:
#        Statement:
#        - Effect: Allow
#          Principal:
#            Service: [ecs.amazonaws.com]
#          Action: ['sts:AssumeRole']
#      Path: /
#      Policies:
#      - PolicyName: ecs-service
#        PolicyDocument:
#          Statement:
#          - Effect: Allow
#            Action: ['elasticloadbalancing:DeregisterInstancesFromLoadBalancer', 'elasticloadbalancing:DeregisterTargets',
#              'elasticloadbalancing:Describe*', 'elasticloadbalancing:RegisterInstancesWithLoadBalancer',
#              'elasticloadbalancing:RegisterTargets', 'ec2:Describe*', 'ec2:AuthorizeSecurityGroupIngress']
#            Resource: '*'
#  ServiceScalingTarget:
#    Type: AWS::ApplicationAutoScaling::ScalableTarget
#    DependsOn: service
#    Properties:
#      MaxCapacity: 1
#      MinCapacity: 1
#      ResourceId: !Join ['', [service/, !Ref 'ECSCluster', /, !GetAtt [service, Name]]]
#      RoleARN: !GetAtt [AutoscalingRole, Arn]
#      ScalableDimension: ecs:service:DesiredCount
#      ServiceNamespace: ecs
#  ServiceScalingPolicy:
#    Type: AWS::ApplicationAutoScaling::ScalingPolicy
#    Properties:
#      PolicyName: AStepPolicy
#      PolicyType: StepScaling
#      ScalingTargetId: !Ref 'ServiceScalingTarget'
#      StepScalingPolicyConfiguration:
#        AdjustmentType: PercentChangeInCapacity
#        Cooldown: 60
#        MetricAggregationType: Average
#        StepAdjustments:
#        - MetricIntervalLowerBound: 0
#          ScalingAdjustment: 200
#  ALB500sAlarmScaleUp:
#    Type: AWS::CloudWatch::Alarm
#    Properties:
#      EvaluationPeriods: '1'
#      Statistic: Average
#      Threshold: '10'
#      AlarmDescription: Alarm if our ALB generates too many HTTP 500s.
#      Period: '60'
#      AlarmActions: [!Ref 'ServiceScalingPolicy']
#      Namespace: AWS/ApplicationELB
#      Dimensions:
#        - Name: LoadBalancer
#          Value: !GetAtt
#            - ECSALB
#            - LoadBalancerFullName
#      ComparisonOperator: GreaterThanThreshold
#      MetricName: HTTPCode_ELB_5XX_Count
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      RoleName: !Sub IAMR-OQS-${Environment}-${ClusterType}
      Description: Allows EC2 instances to call AWS services on your behalf.
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
  EC2RolePolicy:
    Type: 'AWS::IAM::ManagedPolicy'   
    Properties:
      ManagedPolicyName: !Sub 'IAMP-OQS-${Environment}-${ClusterType}ECS'
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - cloudwatch:PutMetricData
              - ec2:DescribeVolumes
              - ec2:DescribeTags
              - ecs:CreateCluster
              - ecs:DeregisterContainerInstance
              - ecs:DiscoverPollEndpoint
              - ecs:Poll
              - ecs:RegisterContainerInstance
              - ecs:StartTelemetrySession
              - ecs:UpdateContainerInstancesState
              - ecr:GetAuthorizationToken
              - ecr:BatchCheckLayerAvailability
              - ecr:GetDownloadUrlForLayer
              - ecr:BatchGetImage
              - ecs:Submit*
              - logs:CreateLogStream
              - logs:DescribeLogStreams
              - logs:PutLogEvents
            Resource: '*'
          - Effect: Allow
            Action:
              - s3:ListBucket
              - s3:DeleteObject
              - s3:DeleteObjectTagging
              - s3:DeleteObjectVersionTagging
              - s3:GetObject
              - s3:GetObjectTagging
              - s3:GetObjectVersionTagging
              - s3:PutObject
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
            Resource:
              - arn:aws:s3:::oqs-st2-a
              - arn:aws:s3:::oqs-st2-a/*
              - arn:aws:s3:::s3-oqs-st2-accountmanagement01-a
              - arn:aws:s3:::s3-oqs-st2-accountmanagement01-a/*
              - arn:aws:s3:::s3-oqs-st2-linked-file-storage01-a
              - arn:aws:s3:::s3-oqs-st2-linked-file-storage01-a/*
              - arn:aws:s3:::cr-cm-ap-result-certification
              - arn:aws:s3:::cr-cm-ap-result-certification/*
              - arn:aws:s3:::prod-ap-northeast-1-starport-layer-bucket
              - arn:aws:s3:::prod-ap-northeast-1-starport-layer-bucket/*
              - arn:aws:s3:::s3-oqs-st2-intermediate-server-linked01-a
              - arn:aws:s3:::s3-oqs-st2-intermediate-server-linked01-a/*
              - arn:aws:s3:::s3-oqs-st2-linking-report-input01-a
              - arn:aws:s3:::s3-oqs-st2-linking-report-input01-a/*
              - arn:aws:s3:::s3-oqs-st2-linking-report-output01-a
              - arn:aws:s3:::s3-oqs-st2-linking-report-output01-a/*
              - arn:aws:s3:::s3-oqs-st2-accountmanagement02-a
              - arn:aws:s3:::s3-oqs-st2-accountmanagement02-a/*
              - arn:aws:s3:::s3-oqs-st2-accountmanagement03-a
              - arn:aws:s3:::s3-oqs-st2-accountmanagement03-a/*
              - arn:aws:s3:::s3-oqs-st2-accountmanagement04-a
              - arn:aws:s3:::s3-oqs-st2-accountmanagement04-a/*
              - arn:aws:s3:::s3-oqs-st2-accountmanagement05-a
              - arn:aws:s3:::s3-oqs-st2-accountmanagement05-a/*
              - arn:aws:s3:::s3-oqs-st2-accountmanagement06-a
              - arn:aws:s3:::s3-oqs-st2-accountmanagement06-a/*
              - arn:aws:s3:::s3-oqs-st2-ecs-userdata-file01
              - arn:aws:s3:::s3-oqs-st2-ecs-userdata-file01/*
              - arn:aws:s3:::s3-oqs-st2-orgcrl01-a
              - arn:aws:s3:::s3-oqs-st2-orgcrl01-a/*
              - arn:aws:s3:::s3-oqs-st2-master-input-a
              - arn:aws:s3:::s3-oqs-st2-master-input-a/*
              - arn:aws:s3:::s3-oqs-st2-master-output-a
              - arn:aws:s3:::s3-oqs-st2-master-output-a/*
              - arn:aws:s3:::s3-oqs-st2-proc-result-storage01-a
              - arn:aws:s3:::s3-oqs-st2-proc-result-storage01-a/*
              - arn:aws:s3:::s3-oqs-st2-ikoucheck-bucket01-a
              - arn:aws:s3:::s3-oqs-st2-ikoucheck-bucket01-a/*
              - arn:aws:s3:::s3-oqs-st2-es-input-a
              - arn:aws:s3:::s3-oqs-st2-es-input-a/*
              - arn:aws:s3:::s3-oqs-st2-es-output-a
              - arn:aws:s3:::s3-oqs-st2-es-output-a/*
          - Effect: Allow
            Action:
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:ListMultipartUploadParts
              - s3:AbortMultipartUpload
              - s3:DeleteObject
              - s3:DeleteObjectTagging
              - s3:DeleteObjectVersionTagging
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:GetObjectTagging
              - s3:GetObjectVersionTagging
              - s3:PutObject
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:PutObjectAcl
            Resource:
              - arn:aws:s3:::s3-oqs-st2-operationdailyreport-a
              - arn:aws:s3:::s3-oqs-st2-operationdailyreport-a/*
              - arn:aws:s3:::s3-oqs-st2-atn-a
              - arn:aws:s3:::s3-oqs-st2-atn-a/*
          - Effect: Allow
            Action:
              - dynamodb:DescribeTable
              - dynamodb:ListGlobalTables
              - dynamodb:ListTables
              - dynamodb:UpdateTable
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:DeleteItem
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:Query
              - dynamodb:UpdateItem
            Resource:
              - arn:aws:dynamodb:ap-northeast-1:936323190821:table/ST2_K_TODAY_SHIKAKU_INFO_HIHOSHO_A
              - arn:aws:dynamodb:ap-northeast-1:936323190821:table/ST2_K_TODAY_SHIKAKU_INFO_SERIAL_A
              - arn:aws:dynamodb:ap-northeast-1:936323190821:table/middle-api-connection
              - arn:aws:dynamodb:ap-northeast-1:936323190821:table/middle-nopinapi-connection
          - Effect: Allow
            Action:
              - cognito-idp:AdminInitiateAuth
            Resource:
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_2cOkSVXU2
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_6Lu5RKicD
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_LzHLmOXxZ
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_nrf9s8lRC
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_lrywcf5tI
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_bTRwt1HOu
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_gAzVWTPD1
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_09Sy383Uo
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_Jd1As5xSu
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_bAhlS060e
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_yt9SrhKoO
              - arn:aws:cognito-idp:ap-northeast-1:936323190821:userpool/ap-northeast-1_2cOkSVXU2
      Roles: 
        - !Ref EC2Role
  EC2RolePolicyAthenaFullAccess:
    Type: 'AWS::IAM::ManagedPolicy'   
    Properties:
      ManagedPolicyName: !Sub 'IAMP-OQS-${Environment}-${ClusterType}ECS-AthenaFullAccess'
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - athena:*
            Resource: '*'
          - Effect: Allow
            Action:
              - glue:CreateDatabase
              - glue:DeleteDatabase
              - glue:GetDatabase
              - glue:GetDatabases
              - glue:UpdateDatabase
              - glue:CreateTable
              - glue:DeleteTable
              - glue:BatchDeleteTable
              - glue:UpdateTable
              - glue:GetTable
              - glue:GetTables
              - glue:BatchCreatePartition
              - glue:CreatePartition
              - glue:DeletePartition
              - glue:BatchDeletePartition
              - glue:UpdatePartition
              - glue:GetPartition
              - glue:GetPartitions
              - glue:BatchGetPartition
            Resource: '*'
      Roles: 
        - !Ref EC2Role
  AutoscalingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [application-autoscaling.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
      - PolicyName: !Sub IAMP-OQS-${Environment}-service-autoscaling
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: ['application-autoscaling:*', 'cloudwatch:DescribeAlarms', 'cloudwatch:PutMetricAlarm',
              'ecs:DescribeServices', 'ecs:UpdateService']
            Resource: '*'
  ASGTerminateHook:
    Type: "AWS::AutoScaling::LifecycleHook"
    Properties:
      AutoScalingGroupName: !Ref ECSAutoScalingGroup
      DefaultResult: "ABANDON"
      HeartbeatTimeout: "900"
      LifecycleTransition: "autoscaling:EC2_INSTANCE_TERMINATING"
      NotificationMetadata:  !Sub ECS-OQS-${Environment}-${ClusterType}${Number}
      NotificationTargetARN: !Sub arn:aws:sns:ap-northeast-1:936323190821:SNS-OQS-${Environment}-ASGLifeCycleHook
      RoleARN: !Sub arn:aws:iam::936323190821:role/IAMR-OQS-${Environment}-ASGLifeCycleHook
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles: 
        - !Ref EC2Role
